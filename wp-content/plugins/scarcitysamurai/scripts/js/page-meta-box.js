// Generated by CoffeeScript 1.4.0

/*

LEGAL COPYRIGHT NOTICE

Copyright (c) Noble Samurai Pty Ltd, 2008-2013. All Rights Reserved.

This software is proprietary to and embodies the confidential technology of Noble Samurai Pty Ltd.
Possession, use, dissemination or copying of this software and media is authorised only pursuant
to a valid written license from Noble Samurai Pty Ltd. Questions or requests regarding permission may
be sent by email to legal@noblesamurai.com or by post to PO Box 477, Blackburn Victoria 3130, Australia.
*/


(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  jQuery(function($) {
    var ScarcitySamuraiPageMetaBox;
    ScarcitySamuraiPageMetaBox = (function() {

      function ScarcitySamuraiPageMetaBox() {
        this.updateWarnings = __bind(this.updateWarnings, this);
        this.settings = scarcitySamuraiData;
        this.pageId = parseInt(this.settings.page_id, 10);
        this.$campaignSelect = $('.ss-page-campaign');
        this.$containsOptInFormCheckbox = $('.ss-contains-opt-in-form');
        this.$autoResponderWrapper = $('.ss-auto-responder-wrapper');
        this.$autoResponderSelect = $('.ss-auto-responder-select');
        this.$autoResponderNotSelectedMessage = $('.ss-auto-responder-not-selected-message');
        this.$autoResponderSelectedMessage = $('.ss-auto-responder-selected-message');
        this.$autoResponderShortName = $('.ss-auto-responder-short-name');
        this.$autoResponderConfigurationInstructionsLink = $('.ss-auto-responder-configuration-instructions-link');
        this.$accessRestrictionEnable = $('[name="ss-page-lock-enable"]');
        this.$accessRestrictionOptIn = $('[name="ss-page-lock-from"][value="opt_in"]');
        this.$accessRestrictionOptInPage = $('[name="ss-page-lock-from-optin-page-id"]');
        this.$accessRestrictionNoPagesWithOptInForm = $('#ss-page-lock-tab-panel .ss-no-pages-with-opt-in-form');
        this.$countDownTimerOptIn = $('[name="ss-page-timer-from"][value="opt_in"]');
        this.$countDownTimerOptInPage = $('[name="ss-page-timer-from-optin-page-id"]');
        this.$countDownTimerNoPagesWithOptInForm = $('#ss-page-timer-tab-panel .ss-no-pages-with-opt-in-form');
        $('.ss-campaign-select').select2({
          width: '300px'
        });
        $('.ss-auto-responder-select').select2({
          placeholder: 'Please select...',
          width: '205px'
        });
        $('.ss-page-select').select2({
          placeholder: 'Select a page...',
          width: '300px'
        });
        $('.ss-timezone-select').select2({
          placeholder: 'Select a timezone...',
          width: '220px'
        });
        this.createBindings();
        this.checkLocation();
        this.checkPagesWithOptInForm();
      }

      ScarcitySamuraiPageMetaBox.prototype.checkLocation = function() {
        var match;
        if ((match = window.location.hash.match(/^#(ss-page-(?:lock|timer|banners))$/))) {
          $("." + match[1] + "-tab a").click();
        }
        if (window.location.hash.match(/^#ss-/)) {
          _.delay(function() {
            return window.location.href = window.location.href;
          }, 500);
          return tinyMCE.onAddEditor.add(function(mgr, ed) {
            return ed.onPostRender.add(function(ed, cm) {
              if (ed.id === 'content') {
                return window.location.href = window.location.href;
              }
            });
          });
        }
      };

      ScarcitySamuraiPageMetaBox.prototype.createBindings = function() {
        var self, toggleElementConfiguration,
          _this = this;
        self = this;
        $('#ss-page-tabs li a').click(function() {
          var $tab, tab;
          $tab = $(this).parent();
          $tab.addClass('tabs').removeClass('hide-if-no-js');
          $('#ss-page-tabs li').not($tab).removeClass('tabs').addClass('hide-if-no-js');
          tab = $tab.attr('class').match(/ss-page-([a-z-]*)-tab/);
          if (tab) {
            $('.ss-page-tab-panel').hide();
            $("#ss-page-" + tab[1] + "-tab-panel").show();
          }
          return false;
        }).eq(0).click();
        toggleElementConfiguration = function($element) {
          var toggleElementClass;
          toggleElementClass = $element.data('ss-ui-toggle-element-class');
          return $("." + toggleElementClass).toggle($element[0].checked);
        };
        $('input.ss-ui-toggle').change(function() {
          var radioName;
          toggleElementConfiguration($(this));
          if ($(this).is('[type="radio"]')) {
            radioName = $(this).attr('name');
            return $("[name='" + radioName + "']").not(this).each(function() {
              return toggleElementConfiguration($(this));
            });
          }
        }).change();
        $('input.ul-radio').change(function() {
          if (!this.checked) {
            return;
          }
          $(this).closest('ul').find('div.ss-opts').hide();
          return $(this).closest('li').find('div.ss-opts').show();
        }).change();
        this.$campaignSelect.change(function() {
          $('.ss-page-campaign-page-opts').toggle(this.value !== '');
          self.$campaignSelect.change(this.updateWarnings);
          return self.checkPageReferences(parseInt(this.value));
        }).change();
        this.$containsOptInFormCheckbox.change(function() {
          if (this.checked) {
            return self.$autoResponderWrapper.slideDown();
          } else {
            return self.$autoResponderWrapper.slideUp();
          }
        });
        this.$autoResponderSelect.change(function() {
          var autoResponder;
          if (this.value === '') {
            self.$autoResponderSelectedMessage.slideUp();
            return self.$autoResponderNotSelectedMessage.slideDown();
          } else {
            self.$autoResponderNotSelectedMessage.slideUp();
            self.$autoResponderSelectedMessage.slideDown();
            autoResponder = self.settings.auto_responders[this.value];
            self.$autoResponderShortName.text(autoResponder.short_name);
            return self.$autoResponderConfigurationInstructionsLink.html(autoResponder.configuration_instructions_link);
          }
        });
        $('input[name="ss-page-lock-from"]').change(function() {
          if (!this.checked) {
            return;
          }
          $('.ss-page-lock-optin-only-opts').toggle(this.value === 'opt_in');
          return self.toggleNoPagesWithOptInFormWarnings();
        }).change();
        $('input[name="ss-page-timer-from"]').change(function() {
          if (this.checked) {
            return self.toggleNoPagesWithOptInFormWarnings();
          }
        }).change();
        $.each([this.$accessRestrictionOptInPage, this.$countDownTimerOptInPage], function(index, $el) {
          return $el.change(function() {
            if (this.value === '') {
              return self.checkPagesWithOptInForm();
            }
          });
        });
        $('[name="ss-page-lock-enable"], [name="ss-page-lock-from"]').change(function() {
          var showNotice;
          showNotice = $('[name="ss-page-lock-enable"]').is(':checked') && $('[name="ss-page-lock-from"]:checked').val() === 'opt_in';
          $('#ss-page-timer-optin-notice').toggle(showNotice);
          return $('#ss-page-timer-optin-warning').toggle(!showNotice);
        }).change();
        $('#ss-restrict-to-opt-ins-only').click(function() {
          if (!_this.$accessRestrictionEnable.is(':checked')) {
            _this.$accessRestrictionEnable.click();
          }
          if (!_this.$accessRestrictionOptIn.is(':checked')) {
            _this.$accessRestrictionOptIn.click();
          }
          _this.$accessRestrictionOptInPage.val(_this.$countDownTimerOptInPage.val());
          $('[name="ss-page-lock-from-optin-days"]').val(0);
          $('[name="ss-page-lock-from-optin-hours"]').val(0);
          $('[name="ss-page-lock-from-optin-minutes"]').val(0);
          $('[name="ss-page-lock-from-optin-seconds"]').val(0);
          $('#ss-page-timer-optin-warning').hide();
          return $('#ss-page-timer-optin-notice').show();
        });
        $('.ss-show-value-input').click(function() {
          return $(this).siblings('[type="radio"]').click();
        });
        $('[name="ss-page-timer-enable"]').change(this.updateWarnings).change();
        $('#ss-add-inline-banner-dialog').on('add-inline-banner', function() {
          _this.hasInlineBanners = true;
          return _this.updateWarnings();
        });
        return $('#ss-add-inline-timer-button').on('add-inline-timer', function() {
          _this.hasInlineTimers = true;
          return _this.updateWarnings();
        });
      };

      ScarcitySamuraiPageMetaBox.prototype.updateWarnings = function() {
        var campaignId, timerEnabled;
        this.hasInlineBanners = false;
        this.hasInlineTimers = false;
        campaignId = this.$campaignSelect.val();
        timerEnabled = $('[name="ss-page-timer-enable"]').is(':checked');
        $('.ss-no-campaign-warning').toggle((this.hasInlineBanners || this.hasInlineTimers) && (campaignId === ''));
        $('.ss-no-timer-warning').toggle((this.hasInlineBanners || this.hasInlineTimers) && (campaignId !== '') && !timerEnabled);
        return $('#ss-add-inline-banner-dialog').data('campaign-id', campaignId);
      };

      ScarcitySamuraiPageMetaBox.prototype.checkPageReferences = function(campaignId) {
        return ScarcitySamuraiHelper.ajax('ss_check_page_references', {
          campaign_id: campaignId,
          page_id: this.pageId
        }, function(result) {
          if (result.success !== true) {
            return alert(result.data);
          }
        });
      };

      ScarcitySamuraiPageMetaBox.prototype.checkPagesWithOptInForm = function() {
        var _this = this;
        return ScarcitySamuraiHelper.ajax('ss_check_pages_with_opt_in_form', {
          page_id: this.pageId
        }, function(result) {
          _this.noPagesWithOptInForm = !result.success;
          return _this.toggleNoPagesWithOptInFormWarnings();
        });
      };

      ScarcitySamuraiPageMetaBox.prototype.toggleNoPagesWithOptInFormWarnings = function() {
        this.$accessRestrictionNoPagesWithOptInForm.toggle(this.$accessRestrictionOptIn.is(':checked') && this.noPagesWithOptInForm);
        return this.$countDownTimerNoPagesWithOptInForm.toggle(this.$countDownTimerOptIn.is(':checked') && this.noPagesWithOptInForm);
      };

      return ScarcitySamuraiPageMetaBox;

    })();
    return new ScarcitySamuraiPageMetaBox();
  });

}).call(this);
